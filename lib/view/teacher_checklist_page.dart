import 'package:flutter/material.dart';

import '../data/eccd_questions.dart';
import '../services/assessment_service.dart';
import '../services/pdf_service.dart';
import '../util/domain.dart';
import '../util/navbar.dart';

class TeacherChecklistPage extends StatefulWidget {
  final String role;
  final int userId;

  final int classId;
  final int learnerId;
  final String learnerName;

  const TeacherChecklistPage({
    Key? key,
    required this.role,
    required this.userId,
    required this.classId,
    required this.learnerId,
    required this.learnerName,
  }) : super(key: key);

  @override
  State<TeacherChecklistPage> createState() => _TeacherChecklistPageState();
}

class _TeacherChecklistPageState extends State<TeacherChecklistPage> {
  String selectedLanguage = "English";

  // ✅ 3 assessments
  String selectedAssessment = "Pre-Test";

  String? selectedDomain;
  DateTime? selectedDate;

  final TextEditingController _dateController = TextEditingController();

  final List<String> domains = EccdQuestions.domains;

  final Map<String, bool> yesValues = {};

  @override
  void initState() {
    super.initState();
    _loadSavedAssessment();
  }

  @override
  void dispose() {
    _dateController.dispose();
    super.dispose();
  }

  Future<void> _loadSavedAssessment() async {
    selectedDate = null;

    final results = await AssessmentService.getAssessment(
      learnerId: widget.learnerId,
      classId: widget.classId,
      assessmentType: selectedAssessment,
    );

    yesValues.clear();

    for (final row in results) {
      final dbIndex = int.tryParse(row['question_index'].toString()) ?? 1;
      final key = "${row['domain']}-${dbIndex - 1}";
      final isYes = row['answer'].toString() == '1';
      yesValues[key] = isYes;

      final dateStr = row['date_taken']?.toString();
      if (selectedDate == null && dateStr != null && dateStr.isNotEmpty) {
        selectedDate = DateTime.tryParse(dateStr);
      }
    }

    if (selectedDate != null) {
      _dateController.text =
          "${selectedDate!.month}/${selectedDate!.day}/${selectedDate!.year}";
    } else {
      _dateController.clear();
    }

    if (mounted) setState(() {});
  }

  Color _progressColor(double value) {
    if (value == 0) return Colors.red;
    if (value == 1) return Colors.green;
    return Colors.orange;
  }

  @override
  Widget build(BuildContext context) {
    final isMobile = MediaQuery.of(context).size.width < 700;

    return Scaffold(
      drawer: isMobile
          ? Navbar(
              selectedIndex: 0,
              onItemSelected: (_) {},
              role: widget.role,
              userId: widget.userId,
            )
          : null,
      appBar: AppBar(
        title: const Text("Checklist"),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back),
          onPressed: () => Navigator.pop(context), // ✅ correct back behavior
        ),
        backgroundColor: const Color(0xFFA02A2A),
        foregroundColor: Colors.white,
      ),
      body: SafeArea(
        child: Row(
          children: [
            if (!isMobile)
              Navbar(
                selectedIndex: 0,
                onItemSelected: (_) {},
                role: widget.role,
                userId: widget.userId,
              ),
            Expanded(
              child: Stack(
                children: [
                  SingleChildScrollView(child: _content(isMobile)),
                  Positioned(
                    left: 0,
                    right: 0,
                    bottom: 0,
                    child: _stickyBottomBar(isMobile),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _content(bool isMobile) {
    final lang = EccdQuestions.fromLabel(selectedLanguage);
    final visibleDomains = selectedDomain == null ? domains : [selectedDomain!];

    return Padding(
      padding: EdgeInsets.fromLTRB(
        isMobile ? 12 : 34,
        isMobile ? 12 : 34,
        isMobile ? 12 : 34,
        140,
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _topRow(isMobile),
          const SizedBox(height: 10),

          Text(
            "${widget.learnerName}",
            style: TextStyle(
              fontSize: isMobile ? 22 : 42,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 8),
          LinearProgressIndicator(
            value: _overallProgress(),
            color: _progressColor(_overallProgress()),
            minHeight: 5,
          ),
          const SizedBox(height: 14),

          DomainDropdown(
            domains: ["All Domains", ...domains],
            onChanged: (v) =>
                setState(() => selectedDomain = v == "All Domains" ? null : v),
          ),
          const SizedBox(height: 18),

          ...visibleDomains.map((domain) {
            final questions = EccdQuestions.get(domain, lang);

            return Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  domain,
                  style: const TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 6),
                LinearProgressIndicator(
                  value: _domainProgress(domain, questions.length),
                  color: _progressColor(
                    _domainProgress(domain, questions.length),
                  ),
                  minHeight: 5,
                ),
                const SizedBox(height: 14),

                ...List.generate(questions.length, (i) {
                  final key = "$domain-$i";
                  yesValues.putIfAbsent(key, () => false);

                  return Padding(
                    padding: const EdgeInsets.symmetric(vertical: 10),
                    child: Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        GestureDetector(
                          onTap: () => setState(
                            () => yesValues[key] = !(yesValues[key] ?? false),
                          ),
                          child: Container(
                            width: isMobile ? 18 : 24,
                            height: isMobile ? 18 : 24,
                            margin: const EdgeInsets.only(right: 14, top: 2),
                            decoration: BoxDecoration(
                              border: Border.all(
                                color: Colors.black,
                                width: 1.5,
                              ),
                              color: (yesValues[key] ?? false)
                                  ? Colors.black
                                  : Colors.white,
                            ),
                          ),
                        ),
                        Expanded(
                          child: Text(
                            "${i + 1}. ${questions[i]}",
                            style: const TextStyle(fontSize: 16, height: 1.5),
                          ),
                        ),
                      ],
                    ),
                  );
                }),

                const SizedBox(height: 22),
              ],
            );
          }),
        ],
      ),
    );
  }

  Widget _topRow(bool isMobile) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        SizedBox(
          width: isMobile ? 180 : 320,
          child: DropdownButtonFormField<String>(
            value: selectedAssessment,
            items: const [
              DropdownMenuItem(value: "Pre-Test", child: Text("Pre-Test")),
              DropdownMenuItem(value: "Post-Test", child: Text("Post-Test")),
              DropdownMenuItem(
                value: "Conditional Test",
                child: Text("Conditional Test"),
              ),
            ],
            onChanged: (v) async {
              setState(() => selectedAssessment = v!);
              await _loadSavedAssessment();
            },
            decoration: const InputDecoration(labelText: "Assessment"),
          ),
        ),
        const Spacer(),
        SizedBox(
          width: isMobile ? 140 : 190,
          child: DropdownButtonFormField<String>(
            value: selectedLanguage,
            items: const [
              DropdownMenuItem(value: "English", child: Text("English")),
              DropdownMenuItem(value: "Tagalog", child: Text("Tagalog")),
            ],
            onChanged: (v) => setState(() => selectedLanguage = v!),
            decoration: const InputDecoration(labelText: "Language"),
          ),
        ),
        const SizedBox(width: 10),
        SizedBox(
          width: isMobile ? 150 : 220,
          child: TextField(
            controller: _dateController,
            readOnly: true,
            decoration: const InputDecoration(labelText: "Date"),
            onTap: _pickDate,
          ),
        ),
      ],
    );
  }

  Widget _stickyBottomBar(bool isMobile) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      decoration: BoxDecoration(
        color: Colors.white,
        border: Border(top: BorderSide(color: Colors.grey.shade300)),
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.end,
        children: [
          SizedBox(
            height: isMobile ? 36 : 42,
            child: ElevatedButton(
              style: ElevatedButton.styleFrom(backgroundColor: Colors.black),
              onPressed: _saveAssessment,
              child: const Text("Save", style: TextStyle(color: Colors.white)),
            ),
          ),
          const SizedBox(width: 12),
          SizedBox(
            height: isMobile ? 36 : 42,
            child: ElevatedButton(
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFFA02A2A),
              ),
              onPressed: _exportSummary,
              child: const Text(
                "Export Summary",
                style: TextStyle(color: Colors.white),
              ),
            ),
          ),
        ],
      ),
    );
  }

  void _pickDate() async {
    final picked = await showDatePicker(
      context: context,
      initialDate: selectedDate ?? DateTime.now(),
      firstDate: DateTime(2015),
      lastDate: DateTime.now(),
    );
    if (picked != null) {
      setState(() {
        selectedDate = picked;
        _dateController.text = "${picked.month}/${picked.day}/${picked.year}";
      });
    }
  }

  Future<void> _saveAssessment() async {
    if (selectedDate == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Please select a date before saving")),
      );
      return;
    }

    final Map<String, bool> fullAnswerMap = Map<String, bool>.from(yesValues);

    try {
      await AssessmentService.saveAssessment(
        learnerId: widget.learnerId,
        classId: widget.classId,
        assessmentType: selectedAssessment,
        date: selectedDate!,
        yesValues: fullAnswerMap,
      );

      // ✅ Reload the exact same assessment type from DB so UI matches persisted values
      await _loadSavedAssessment();

      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Assessment saved (persisted in database)."),
        ),
      );
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text("Error saving assessment: $e")));
    }
  }

  Future<void> _exportSummary() async {
    final file = await PdfService.generateReport(
      widget.learnerName,
      _computeProgress(),
    );
    ScaffoldMessenger.of(
      context,
    ).showSnackBar(SnackBar(content: Text("PDF saved: ${file.path}")));
  }

  Map<String, double> _computeProgress() {
    final Map<String, List<bool>> map = {};
    yesValues.forEach((k, v) {
      final d = k.split('-').first;
      map.putIfAbsent(d, () => []);
      map[d]!.add(v);
    });

    return map.map(
      (k, v) =>
          MapEntry(k, v.isEmpty ? 0 : v.where((e) => e).length / v.length),
    );
  }

  double _domainProgress(String domain, int questionCount) {
    if (questionCount == 0) return 0;
    int yes = 0;
    for (int i = 0; i < questionCount; i++) {
      if (yesValues["$domain-$i"] == true) yes++;
    }
    return yes / questionCount;
  }

  double _overallProgress() {
    if (yesValues.isEmpty) return 0;
    return yesValues.values.where((v) => v).length / yesValues.length;
  }
}
